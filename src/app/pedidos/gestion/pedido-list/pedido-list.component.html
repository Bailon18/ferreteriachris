<div class="pedido-list-container">
  <h3 class="mb-4">Gestión de Pedidos</h3>

  <!-- Botones de exportación -->
  <div class="mb-3 text-end">
    <button class="btn btn-danger me-2" (click)="exportarPDF()">
      <i class="fas fa-file-pdf"></i> Exportar PDF
    </button>
    <button class="btn btn-success" (click)="exportarExcel()">
      <i class="fas fa-file-excel"></i> Exportar Excel
    </button>
  </div>

  <!-- Filtros modernos -->
  <div class="pedido-filters-card mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-5 col-12">
        <div class="d-flex flex-wrap gap-2">
          <button class="btn"
                  [class.btn-primary]="estadoFiltro === null"
                  (click)="onEstadoChange(null)">
            Todos
          </button>
          <button *ngFor="let estado of estados"
                  class="btn"
                  [ngClass]="{
                    'btn-success': estado === 'ENTREGADO' && estadoFiltro === estado,
                    'btn-warning': estado === 'PENDIENTE' && estadoFiltro === estado,
                    'btn-info': estado === 'EN_PROCESO' && estadoFiltro === estado,
                    'btn-secondary': estado === 'PREPARADO' && estadoFiltro === estado,
                    'btn-danger': estado === 'CANCELADO' && estadoFiltro === estado
                  }"
                  (click)="onEstadoChange(estado)">
            {{ estado }}
          </button>
        </div>
      </div>
      <div class="col-md-7 col-12">
        <div class="row g-2">
          <div class="col-auto">
            <label class="form-label mb-1">Fecha inicio</label>
            <input type="date" 
                   class="form-control" 
                   [(ngModel)]="fechaInicio"
                   (change)="onFechaChange()">
          </div>
          <div class="col-auto">
            <label class="form-label mb-1">Fecha fin</label>
            <input type="date" 
                   class="form-control" 
                   [(ngModel)]="fechaFin"
                   (change)="onFechaChange()">
          </div>
          <div class="col-auto d-flex align-items-end gap-2">
            <button class="btn btn-primary" 
                    (click)="onFiltrarPorFecha()" 
                    [disabled]="!fechaInicio || !fechaFin || !fechasValidas">
              Filtrar
            </button>
            <button class="btn btn-outline-secondary" 
                    (click)="limpiarFiltroFecha()" 
                    [disabled]="!fechaInicio && !fechaFin">
              Limpiar
            </button>
          </div>
          <div class="col-12" *ngIf="!fechasValidas">
            <div class="alert alert-danger py-2 mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ mensajeErrorFechas }}
            </div>
          </div>
        </div>
      </div>
      <div class="col-auto" *ngIf="esAdmin">
        <label class="form-label mb-1">Vendedor</label>
        <select class="form-select" [(ngModel)]="vendedorFiltro" (change)="onVendedorChange()">
          <option [ngValue]="null">Todos</option>
          <option *ngFor="let vendedor of vendedores" [ngValue]="vendedor.id">
            {{ vendedor.name }} {{ vendedor.lastname }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <div class="pedido-table-wrapper">
    <table class="table table-bordered table-hover pedido-table w-100">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Vendedor</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let pedido of pedidos" class="align-middle">
          <td class="fw-semibold text-primary">{{ pedido.id }}</td>
          <td>{{ pedido.cliente?.nombre }} {{ pedido.cliente?.apellido }}</td>
          <td>
            {{ pedido.vendedor?.name || '-' }} {{ pedido.vendedor?.lastname || '' }}
          </td>
          <td>{{ pedido.fechaPedido | date:'dd/MM/yyyy, h:mm a' }}</td>
          <td>
            <span class="badge"
                  [ngClass]="{
                    'bg-success': pedido.estado === 'ENTREGADO',
                    'bg-warning': pedido.estado === 'PENDIENTE',
                    'bg-info': pedido.estado === 'EN_PROCESO',
                    'bg-secondary': pedido.estado === 'PREPARADO',
                    'bg-danger': pedido.estado === 'CANCELADO'
                  }">
              {{ pedido.estado }}
            </span>
          </td>
          <td>S/ {{ pedido.total | number:'1.2-2' }}</td>
          <td style="position: relative;">
            <button class="btn btn-outline-primary btn-sm me-2" title="Ver detalle" (click)="abrirModalDetalle(pedido.id)">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        </tr>
        <tr *ngIf="pedidos.length === 0 && !cargando">
          <td colspan="7" class="text-center">No hay pedidos para mostrar.</td>
        </tr>
        <tr *ngIf="cargando">
          <td colspan="7" class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-2">Cargando...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <nav *ngIf="totalPages > 1">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item" [class.disabled]="pageIndex === 0">
        <button class="page-link" (click)="onPageChange(pageIndex - 1)" [disabled]="pageIndex === 0">
          Anterior
        </button>
      </li>
      <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="i === pageIndex">
        <button class="page-link" (click)="onPageChange(i)">{{ i + 1 }}</button>
      </li>
      <li class="page-item" [class.disabled]="pageIndex >= totalPages - 1">
        <button class="page-link" (click)="onPageChange(pageIndex + 1)"
                [disabled]="pageIndex >= totalPages - 1">
          Siguiente
        </button>
      </li>
    </ul>
  </nav>

  <!-- Modal de detalle -->
  <app-pedido-detail-modal
    *ngIf="mostrarModal"
    [pedidoId]="pedidoSeleccionadoId"
    (pedidoActualizado)="pedidoActualizado()"
    (cerrar)="cerrarModal()">
  </app-pedido-detail-modal>
</div>
